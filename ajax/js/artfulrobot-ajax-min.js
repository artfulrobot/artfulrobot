var artfulrobot=artfulrobot||{};
artfulrobot.defineClass=function(){function a(){this.initialise.apply(this,arguments)}var b;a:{for(b in{toString:1})if("toString"===b){b=!1;break a}b=!0}var c=function(){},d=null,e=[],e=jQuery.makeArray(arguments);"function"==typeof e[0]&&(d=e[0],e.splice(0,1));a.subclasses=[];a.prototype.getCallback=function(a){if(!this[a])throw new artfulrobot.Exception("getCallback: Object does not have '"+a+"'",this);var b=this,c=jQuery.makeArray(arguments);c.shift();return function(){var d=c.concat(jQuery.makeArray(arguments));
b.origContext=this;b[a].apply(b,d)}};a.prototype.toString=function(){return"arlClass object id:"+this.myId};d&&(c.prototype=d.prototype,a.prototype=new c,d.subclasses.push(a),a.prototype.superclass=d.prototype);c=0;for(d=e.length;c<d;c++){var f=a,g=e[c],h=f.prototype.superclass&&f.prototype.superclass,l=artfulrobot.objectKeys(g);b&&(g.toString!=Object.prototype.toString&&l.push("toString"),g.valueOf!=Object.prototype.valueOf&&l.push("valueOf"));for(var k=0,m=l.length;k<m;k++){var j=l[k],n=g[j];h&&
("function"==typeof n&&h[j]&&"function"==typeof h[j])&&(f.prototype["$"+j]=h[j]);f.prototype[j]=n}}a.prototype.initialise||(a.prototype.initialise=function(){});return a.prototype.constructor=a};artfulrobot.countKeys=function(a){if(a.__count__)return a.__count__;var b=0,c;for(c in a)b++;return b};artfulrobot.objectKeys=function(a){var b=[],c;for(c in a)b.push(c);return b};artfulrobot.objectToSerializeArray=function(a){var b=[],c;for(c in a)b.push({name:c,value:a[c]});return b};
artfulrobot.serializeArrayToObject=function(a){for(var b=a.length,c={},d=0;d<b;d++)c[a[d].name]=a[d].value;return c};artfulrobot.typeOf=function(a){var b=typeof a;return"object"===b?a?a instanceof Array?"array":"object":"null":b};artfulrobot.htmlentities={hellip:"\u2026",nbsp:"\u00a0",otimes:"\u2297",pound:"\u00a3"};
artfulrobot.createFragmentFromArray=function(a){var b=artfulrobot.typeOf(a);if("string"===b)return document.createTextNode(a);if("null"===b)alert("Encountered a null, expected string, array, object");else{if("object"===b)a=[a];else if("array"!==b){alert("error: type "+b+" encountered in createFragmentFromArray expected: string, array, object");return}for(var c=a.length,d=document.createDocumentFragment(),e=0;e<c;e++){var f=a[e],b=artfulrobot.typeOf(f);if("string"==b||"number"==b)d.appendChild(document.createTextNode(String(f)));
else if("object"==b){var b=document.createElement(f.element),g;for(g in f)if(-1<",onblur,onchange,onclick,ondblclick,onfocus,onkeydown,onkeypress,onkeyup,onmousedown,onmousemove,onmouseout,onmouseover,onmouseup,onresize,onscroll,onmouseenter,onmouseleave,".indexOf(","+g+",")){var h=g.substr(2);"array"==artfulrobot.typeOf(f[g])?jQuery(b).bind(h,f[g][1],f[g][0]):jQuery(b).bind(h,f[g])}else"element"==g||"content"==g||("innerHTML"==g?b.innerHTML=f[g]:b.setAttribute(g,f[g]));f.content&&b.appendChild(artfulrobot.createFragmentFromArray(f.content));
d.appendChild(b)}else alert("Error:\nartfulrobot.createElement '"+b+"' type encountered within content array, expected string or object")}return d}};
artfulrobot.Exception=artfulrobot.defineClass({initialise:function(){this.details=jQuery.makeArray(arguments);this.message=this.details[0];window.console&&console.error&&console.error.apply(this,["exception args: "].concat(this.details))},details:[],toString:function(){var a="artfulrobot.Exception :"+this.message;for(x in this.details)a+="\n"+this.details[x];return a}});
artfulrobot.getRadioValue=function(a){if(!a)throw new artfulrobot.Exception("getRadioValue called without a radio group name. Got:",a);a=jQuery('input[name="'+a+'"]:checked');return a.length?a[0].value:null};artfulrobot.setSelectOptionByValue=function(a,b){jQuery(a).find("option").each(function(a,d){d.selected=d.value==b})};artfulrobot.setSelectOptionByText=function(a,b){jQuery(a).find("option").each(function(a,d){d.selected=jQuery(d).text()==b})};
artfulrobot.AjaxClass=artfulrobot.defineClass({initialise:function(a){this.requestFrom="ajaxprocess.php";this.method="get";this.requests={};this.uniqueCounter=1;a=a||{};a.requestFrom&&this.setRequestFrom(a.requestFrom);a.method&&this.setMethod(a.method)},setRequestFrom:function(a){this.requestFrom=a||"ajaxprocess.php"},setMethod:function(a){if("get"==a||"post"==a)this.method=a;else throw Error("ajax method must be post or get");},liveRequests:function(){return artfulrobot.countKeys(this.requests)},
request:function(a,b,c,d){if("undefined"==typeof c||!1==c||null===c)c=function(){};var e="ajax"+this.uniqueCounter++,f;f=artfulrobot.typeOf(a);if("string"==f)f=a;else if("object"==f)jQuery.each(a,function(b,c){if(!1===c||void 0===c)a[b]=""}),f=jQuery.param(a);else if("array"==f)jQuery.each(a,function(b,c){if(!1===c.value||void 0===c.value)a[b].value=""}),f=jQuery.param(a);else throw Error("artfulrobot.AjaxClass.request called with params as unkonwn type: '"+f+"'");debugURI=this.requestFrom.match(/^\//)?
window.location.protocol+"//"+window.location.host+this.requestFrom:window.location.protocol+"//"+window.location.host+window.location.pathname.replace(/^(.+\/)[^\/]*?$/,"$1")+this.requestFrom;debugURI+="?"+f+"&debug=1";this.requests[e]={debugURI:debugURI,outputHtmlInsideElement:b,onSuccessCallback:c,live:1,stage:"request"};this.requestStarts(this.requests[e]);"1.5">jQuery().jquery?(window.console&&console.warn&&console.warn("Running old version of jQuery"),jQuery.ajax({url:this.requestFrom,data:f,
type:(d||this.method).toUpperCase(),failure:this.getCallback("onFailure",e),success:this.getCallback("onSuccess",e)})):jQuery.ajax(this.requestFrom,{data:f,type:d||this.method,failure:this.getCallback("onFailure",e),success:this.getCallback("onSuccess",e)});return e},requestEnded:function(a){this.requestEnds(this.requests[a]);delete this.requests[a]},onFailure:function(a,b){alert(a+": Problem! error: "+b.status);b.responseText="";this.requestEnded()},onSuccess:function(a,b){var c=this.requests[a];
c.stage="response-parse-stage-1";c.t=b;try{var d=b,e;e=d.indexOf("}")+1;if(!e){c.stage="response-parse-stage-1 FAIL";this.seriousError("Bad ajax response. I cannot recognise a structure definition in the response. Expected } but none found.",a,d);return}c.stage="response-parse-stage-2";f=d.substr(0,e);if(!/^\{.*?\}$/.test(f)){c.stage="response-parse-stage-2 FAIL";this.seriousError("Bad ajax response. I cannot recognise a structure definition in the response. Structure definition failed regexp.",a,
d);return}try{c.stage="response-parse-stage-3";var f=jQuery.parseJSON(d.substr(0,e))}catch(g){c.stage="response-parse-stage-3 FAIL";this.seriousError("Bad ajax response. Javascript failed to parse structure definition found in the response",a,d);return}var h=d.substr(e,f.objectLength);e+=parseInt(f.objectLength);if(h)try{c.stage="response-parse-json",h=jQuery.parseJSON(h)}catch(l){c.stage="response-parse-json FAIL";this.seriousError("Bad ajax response. Javascript failed to parse returned JSON object",
a,d);return}else h={};c.stage="response-parse-error and text";var k=d.substr(e,f.errorLength);e+=parseInt(f.errorLength);var m=d.substr(e)}catch(j){c.stage="response-parse FAIL";this.seriousError("Bad ajax response.",a,d);return}k&&alert(k);c.stage="replace element innerHTML...";""!=m&&c.outputHtmlInsideElement&&(e=c.outputHtmlInsideElement,e="string"==typeof e?jQuery("#"+e):jQuery(e),e.html(m));c.stage="callback";try{h.requestId=a,this.requests[a].onSuccessCallback(h,m)}catch(n){this.seriousError("Failed on callback function. See artfulrobot.ajax.requests."+
a,a,d);return}this.requestEnded(a)},seriousError:function(a,b,c){window.console&&console.error&&console.error(a,b," ",c);var d=window.open();d.document.write("<html><head><title>Error report</title><style>h2 {color:#800 ;font-size:16px;} h3 {font-size:14px;margin-bottom:0;} div { border:solid 1px #888; background-color:#ffe;padding:1em; } </style></head><body><h2>Error: "+a+'</h3><p><a href="'+this.requests[b].debugURI+'" >Re-issue request with php debugging on</a></p><h3>Request:</h3><div>'+this.requests[b].debugURI.replace(/^(.+?)\?.+$/,
"$1")+"<br /><pre>"+this.requests[b].debugURI.replace(/^(.+?)\?(.+)$/,"$2").replace(/&/g,"<br />")+"</pre></div><h3>Response received:</h3><div>"+c+"</div></body></html>");d.document.close()},requestEnds:function(){},requestStarts:function(){},dump:function(){window.console&&console.log?console.log(this.requests):alert("No console object available")}});artfulrobot.ajax=new artfulrobot.AjaxClass;artfulrobot.arlObjects={};
artfulrobot.ARLObject=artfulrobot.defineClass({nextId:0,debugLevel:0,sharedMethods:{},initialise:function(a,b,c,d){this.myParent=a;this.name="undefined"==typeof b?"ARLObject":b;1<this.debugLevel&&console.info(this.name+".initialise");1<this.debugLevel&&console.log(" session: ",c);artfulrobot.ARLObject.prototype.nextId++;this.myId="arlObjId"+this.nextId;this.subObjects={};this.signals={};this.initialiseSession(c);1<this.debugLevel&&console.info(this.name+".calling localInitialise");"array"!=artfulrobot.typeOf(d)&&
(d=[]);this.localInitialise.apply(this,d);1<this.debugLevel&&console.info(this.name+".initialise done. Claimed id: "+this.myId);1<this.debugLevel&&console.log("ends")},initialiseSession:function(a){this._SESSION="object"==typeof a?a:{}},localInitialise:function(){},getId:function(){return this.myId},shout:function(a,b){1<this.debugLevel&&console.info(this.name+".shout called for "+a);"undefined"==typeof b&&(b={});"undefined"==typeof b.shoutedBy&&(b.shoutedBy=this);if("undefined"!=typeof this.signals[a]){var c=
this.signals[a],d=c.length;1<this.debugLevel&&console.log("signalling direct to "+d+" slots ");for(i=0;i<d;i++)c[i](a,b)}else this.myParent?this.myParent.shout(a,b):this.abstractHear(a,b);1<this.debugLevel&&console.log("ends")},abstractHear:function(a,b){0<this.debugLevel&&console.info(this.name+".hear with sigType: "+a);b.shoutedBy.myId!=this.myId&&this.hear(a,b);1<this.debugLevel&&console.log("back from local hear, calling abstractHear on subobjects..");for(var c in this.subObjects)this.subObjects[c].abstractHear(a,
b);1<this.debugLevel&&console.log("ends")},hear:function(){},addSubObject:function(a,b,c){1<this.debugLevel&&console.info(this.name+".addSubObject called for objClass: "+a);c&&this[c]&&this.destroySubObject(this[c]);var d="unknown";if("string"==typeof a){d=a;if(!window[a])throw new artfulrobot.Exception("artfulrobot.ARLObject.addSubObject: Class '"+a+"' is unknown");a=window[a]}if("object"==!artfulrobot.typeOf(a))throw new artfulrobot.Exception("artfulrobot.ARLObject.addSubObject: supplied class is not a class.",
a);1<this.debugLevel&&console.log(this.name+".addSubObject: About to create subobject:",{type:d,args:b});a=new a(this,d,this.getSessionForSubObject(d),b);1<this.debugLevel&&console.log(this.name+".addSubObject: new object created",a);a.connectSignal("saveSession",this.getCallback("saveSubObjSession"));this.subObjects[a.myId]=a;artfulrobot.arlObjects[a.myId]=a;c&&(a.aliasedAs=c,this[c]=a);1<this.debugLevel&&console.info(this.name+".addSubObject done");1<this.debugLevel&&console.log("ends");return a},
getSessionForSubObject:function(a){var b={};"undefined"!=typeof this._SESSION.subObjects?"undefined"!=typeof this._SESSION.subObjects[a]?b=this._SESSION.subObjects[a]:1<this.debugLevel&&console.log(this.name+".getSessionForSubObject _SESSION.subObjects undefined for "+a):1<this.debugLevel&&console.log(this.name+".getSessionForSubObject _SESSION.subObjects undefined");1<this.debugLevel&&console.log(this.name+".getSessionForSubObject: ",this._SESSION);1<this.debugLevel&&console.info(this.name+".getSessionForSubObject: returning ",
b);return b},saveSession:function(a,b){1<this.debugLevel&&console.info(this.name+".saveSession");1<this.debugLevel&&console.log(this._SESSION);this.myParent&&this.shout("saveSession",{id:this.myId,name:this.name,sessionObj:this._SESSION,newFriendlyName:a,newTitle:b})},saveSubObjSession:function(a,b){1<this.debugLevel&&console.info(this.name+".slotSaveSession");1<this.debugLevel&&console.info(b);"undefined"==typeof this._SESSION.subObjects&&(this._SESSION.subObjects={});this._SESSION.subObjects[b.name]=
b.sessionObj;this.saveSession(b.newFriendlyName,b.newTitle)},destroySubObject:function(a){if(a){var b=artfulrobot.typeOf(a),c;if("string"==b){if(b=a,c=this.subObjects[b],"undefined"==typeof c)throw new artfulrobot.Exception('destroySubObject called for "'+a+'" which is not valid id. I have: '+artfulrobot.objectKeys(this.subObjects).join(", "),this.subObjects);}else if("object"==b)b=a.getId(),c=a;else throw"destroySubObject got type "+b+" needed id or object of an ARL object (PS. also, I ignore null/false)";
1<this.debugLevel&&console.info(this.name+".destroySubObject called for "+b);c&&(a=c.aliasedAs,c.destroy(),delete this.subObjects[b],delete artfulrobot.arlObjects[b],delete c,a&&(this[a]=!1))}},destroySubObjects:function(){-1<this.debugLevel&&console.info(this.name+".destroySubObjects "+this.myId,this.subObjects);for(var a in this.subObjects)this.destroySubObject(a)},destroy:function(){1<this.debugLevel&&console.log(this.name+"->destroy called");this.destroySubObjects();this.cleanup()},cleanup:function(){},
connectSignal:function(a,b){"undefined"==typeof this.signals[a]&&(this.signals[a]=[]);this.signals[a].push(b)},toString:function(){return msg="["+this.name+"] Object"},setSessionDefaults:function(a){"undefined"==typeof this._SESSION&&(this._SESSION={});for(key in a)"undefined"==typeof this._SESSION[key]&&(this._SESSION[key]=a[key])},getObjectByName:function(a){for(i in artfulrobot.arlObjects)if(artfulrobot.arlObjects[i].name==a)return artfulrobot.arlObjects[i]}});
ARLKeepAlive=artfulrobot.defineClass(artfulrobot.ARLObject,{localInitialise:function(){this.pingInABit()},pingInABit:function(){this.timer=setTimeout(this.getCallback("ping"),12E4)},ping:function(){artfulrobot.ajax.request({arlClass:"keepalive"},"",this.getCallback("pingRtn"))},pingRtn:function(a){if(a.success)this.pingInABit();else throw alert("Keep alive failed!"),"Keep alive failed!";},cleanup:function(){this.timer&&clearTimeout(this.timer)}});